<!-- REEMPLAZA SOLO EL BLOQUE <script> COMPLETO POR ESTE -->
<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzHdTk7vQe8amrJ9Mg2OGhko1AZQ58IhLOZsMYrYJpIGBSzeqJHR2pjWa3_V8dm-siMVQ/exec"; // <-- pega aquí tu /exec real

if (!SCRIPT_URL || !SCRIPT_URL.startsWith("https://script.google.com/macros/s/")) {
  document.getElementById("estado").textContent = "SCRIPT_URL inválido: https://script.google.com/macros/s/AKfycbzHdTk7vQe8amrJ9Mg2OGhko1AZQ58IhLOZsMYrYJpIGBSzeqJHR2pjWa3_V8dm-siMVQ/exec";
}

let DATA = {
  listas: { grados:[], suministros:[], turnos:[], grupos:[], salaControl:[], minas:[] },
  cncRows: [],
  posturasPorMina: {}
};

function setEstado(msg, ok=true){
  const el = document.getElementById("estado");
  el.textContent = msg;
  el.style.color = ok ? "#0a7a20" : "#b00020";
}

function fillSelect(id, values, placeholder="Seleccionar..."){
  const sel = document.getElementById(id);
  sel.innerHTML = `<option value="">${placeholder}</option>`;
  [...new Set(values.filter(v => v !== "" && v != null))].forEach(v=>{
    const o = document.createElement("option");
    o.value = v;
    o.textContent = v;
    sel.appendChild(o);
  });
}

function cargarListas(){
  fetch(SCRIPT_URL + "?action=datos")
    .then(r => { if(!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
    .then(json => {
      DATA = json;

      fillSelect("grado",      DATA.listas.grados);
      fillSelect("suministro", DATA.listas.suministros);
      fillSelect("turno",      DATA.listas.turnos);
      fillSelect("grupo",      DATA.listas.grupos);

      // Sala Control (nuevo desplegable)
      // OJO: tu HTML original no tenía este select; debes agregarlo en el formulario
      if (document.getElementById("salaControl")) {
        fillSelect("salaControl", DATA.listas.salaControl);
      }

      // Mina y Postura (desplegables)
      fillSelect("minaSel", DATA.listas.minas, "Seleccionar mina...");
      fillSelect("posturaSel", [], "Seleccionar postura...");

      // CNC Responsable
      const responsables = DATA.cncRows.map(r=>r.RESPONSABLE_CNC).filter(Boolean);
      fillSelect("resp", responsables);

      setEstado("Listas cargadas desde Google Sheets (DATOS).", true);
      actualizarResumen();
    })
    .catch(err=>{
      console.error(err);
      setEstado("No se pudo leer la hoja DATOS desde Google Sheets.", false);
    });
}

/* ===== CNC ANIDADO ===== */
const selResp = document.getElementById("resp");
const selCnc1 = document.getElementById("cnc1");
const selCnc2 = document.getElementById("cnc2");

selResp.addEventListener("change", ()=>{
  const filtrado = DATA.cncRows.filter(d => d.RESPONSABLE_CNC === selResp.value);
  fillSelect("cnc1", filtrado.map(d=>d.CNC_NIVEL_1));
  fillSelect("cnc2", []);
  actualizarResumen();
});

selCnc1.addEventListener("change", ()=>{
  const filtrado = DATA.cncRows.filter(d =>
    d.RESPONSABLE_CNC === selResp.value &&
    d.CNC_NIVEL_1 === selCnc1.value
  );
  fillSelect("cnc2", filtrado.map(d=>d.CNC_NIVEL_2));
  actualizarResumen();
});

selCnc2.addEventListener("change", actualizarResumen);

/* ===== MINA / POSTURA ANIDADO ===== */
const minaSel = document.getElementById("minaSel");
const posturaSel = document.getElementById("posturaSel");

minaSel.addEventListener("change", ()=>{
  const mina = minaSel.value;
  const posturas = (DATA.posturasPorMina && DATA.posturasPorMina[mina]) ? DATA.posturasPorMina[mina] : [];
  fillSelect("posturaSel", posturas, "Seleccionar postura...");
  actualizarResumen();
});

posturaSel.addEventListener("change", actualizarResumen);

/* ===== RESUMEN ===== */
function actualizarResumen(){
  const g  = grado.value;
  const t  = turno.value;
  const gr = grupo.value;

  const mi = minaSel.value;
  const po = posturaSel.value;

  const r  = resp.value;
  const c1 = cnc1.value;
  const c2 = cnc2.value;

  document.getElementById("resumen").innerHTML =
    `Grado <span>${g || "-"}</span> · Turno <span>${t || "-"}</span> · Grupo <span>${gr || "-"}</span> · `+
    `Mina <span>${mi || "-"}</span> · Postura <span>${po || "-"}</span><br>`+
    `CNC <span>${r || "-"}</span> / <span>${c1 || "-"}</span> / <span>${c2 || "-"}</span>`;
}

document.querySelectorAll("select,input,textarea")
  .forEach(el => el.addEventListener("change", actualizarResumen));

/* ===== GUARDAR (POST) ===== */
function guardarRegistro(){
  const payload = {
    fechaIso: new Date().toISOString(),
    usuario: (document.getElementById("usuario").value || "SIN_USUARIO"),
    grado: grado.value,
    suministro: suministro.value,
    turno: turno.value,
    grupo: grupo.value,
    mina: minaSel.value,
    postura: posturaSel.value,
    resp: resp.value,
    cnc1: cnc1.value,
    cnc2: cnc2.value,
    salaControl: (document.getElementById("salaControl") ? document.getElementById("salaControl").value : ""),
    observacion: (document.getElementById("obs").value || ""),
    userAgent: navigator.userAgent
  };

  if (!payload.grado || !payload.suministro || !payload.turno || !payload.grupo || !payload.mina || !payload.postura) {
    alert("Completa al menos Grado, Suministro, Turno, Grupo, Mina y Postura antes de guardar.");
    return;
  }

  setEstado("Enviando registro a Google Sheets (HORMIGONES)…", true);

  fetch(SCRIPT_URL, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  })
  .then(r => { if(!r.ok) throw new Error("HTTP " + r.status); return r.json().catch(()=>({status:"OK"})); })
  .then(() => setEstado("Registro guardado correctamente en HORMIGONES.", true))
  .catch(err => {
    console.error(err);
    setEstado("Error guardando en Google Sheets. Revisa el Deploy/Permisos.", false);
  });
}

/* ===== HISTORIAL ===== */
function cargarHistorial(){
  const cont = document.getElementById("historial");
  cont.textContent = "Cargando historial…";

  fetch(SCRIPT_URL + "?action=historial")
    .then(r => { if(!r.ok) throw new Error("HTTP " + r.status); return r.json(); })
    .then(json => {
      const data = json.registros || [];
      if (!data.length){ cont.textContent = "Sin registros en el historial aún."; return; }

      let html = "<table><tr>" +
        "<th>FECHA</th><th>TURNO</th><th>GRUPO</th><th>MINA</th><th>POSTURA</th>" +
        "<th>GRADO</th><th>SUMINISTRO</th><th>CNC2</th><th>CNC1</th><th>RESP</th><th>SALA CTRL</th>" +
        "</tr>";

      data.slice(-50).reverse().forEach(r=>{
        html += `<tr>
          <td>${r["FECHA"] || ""}</td>
          <td>${r["TURNO"] || ""}</td>
          <td>${r["GRUPO"] || ""}</td>
          <td>${r["MINA"] || ""}</td>
          <td>${r["LABOR/POSTURA"] || ""}</td>
          <td>${r["GRADO"] || ""}</td>
          <td>${r["SUMINISTRO"] || ""}</td>
          <td>${r["CNC NIVEL 2"] || ""}</td>
          <td>${r["CNC NIVEL 1"] || ""}</td>
          <td>${r["RESPONSABLE CNC"] || ""}</td>
          <td>${r["SALA DE CONTROL"] || ""}</td>
        </tr>`;
      });

      html += "</table>";
      cont.innerHTML = html;
    })
    .catch(err => {
      console.error(err);
      cont.textContent = "Error leyendo historial desde Google Sheets.";
    });
}

/* ===== INIT ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  cargarListas();
  actualizarResumen();
});
</script>
